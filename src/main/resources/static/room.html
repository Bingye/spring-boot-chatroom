<!DOCTYPE html>
<html>
<head>
    <title>房间</title>
   	<meta charset="UTF-8"/>
</head>
<body>
	<div style="text-align: left">
		<h1>房间</h1>
		<div id="messages" style="text-align: left"></div><br/>
		<textarea rows="5" cols="30" id="content"></textarea><br/>
		<input type="submit" id="submit" value="发送" onclick="sendMsg()" />
	</div>
</body>

<script type="text/javascript" src="/spring-boot-chatroom/js/jquery-3.5.1.min.js"></script>
<script type="text/javascript">

$(document).keyup(function(event){
  	if(event.keyCode ==13){
    	$("#submit").trigger("click");
  	}
});

//webSocket对象
var ws;
//时间间隔
var tt;

var messageHtml;

if ("WebSocket" in window) {
    console.log("支持WebSocket")
} else {
    alert("该浏览器不支持WebSocket")
}

//获取房间号
var roomId = getQueryString("roomId");

var wsUrl = 'ws://localhost/spring-boot-chatroom/websocket/' + roomId;
//创建链接
try {
	if(ws!=null){
		alert("链接已经创建，请关闭页面或刷新页面");
	}else{
		//成功
        ws = new WebSocket(wsUrl);
        webSocketInit(wsUrl);//初始化webSocket连接函数
	}
} catch (e) {
    //失败
    console.log('catch');
}

//发送消息
function sendMsg() {
    var text = $.trim($("#content").val());
    
    if($.trim(text).length==0){
    	$("#content").focus();
    	$("#content").val("");
    	alert("消息不能为空");
    	return;
    }
    console.log("text:" + text);
    var message = {
      	"msgType":"TALK",
        "message": text
    };
  	//向ws发送信息
    ws.send(JSON.stringify(message));
    $("#content").val("");
}


//初始化方法，成功后执行
function webSocketInit(wsUrl) {
    //连接关闭函数
    ws.onclose = function () {
        console.log("连接已关闭...");
    };
    //连接错误函数
    ws.onerror = function () {
        console.log("连接错误...");
    };
    //连接建立,发送信息
    ws.onopen = function () {
    	messageHtml = sessionStorage.getItem("messageHtml");
    	if(messageHtml){
    		$("#messages").html(messageHtml);		
    	}
    };
    ws.onmessage = function (evt) {
        //接受消息
    	var msg = JSON.parse(evt.data);
        
        //进入房间
        if(msg.msgType=="ENTROOM"){
        	$("#messages").append("<br /><font style='color:red'>" +msg.sendtime+": " + msg.fromuser + "进入房间</font>");        		
		
        //离开房间
        }else if(msg.msgType=="LEVROOM"){
        	$("#messages").append("<br /><font style='color:red'>" +msg.sendtime+": " + msg.fromuser + "离开房间</font>");        		
        
        //聊天
        }else if(msg.msgType=="TALK"){
        	$("#messages").append("<br /><font style='color:gray'>" +msg.sendtime+": " + msg.fromuser + "说:</font>" + "<br /><font style='color:blue'>" + msg.message +"</font>");
        	
        	messageHtml = sessionStorage.getItem("messageHtml");
        	if(messageHtml){
        		messageHtml += "<br /><font style='color:gray'>" +msg.sendtime+": " + msg.fromuser + "说:</font>" + "<br /><font style='color:blue'>" + msg.message +"</font>"; 
            	sessionStorage.setItem("messageHtml",messageHtml);
        	}else{
        		messageHtml = "<br /><font style='color:gray'>" +msg.sendtime+": " + msg.fromuser + "说:</font>" + "<br /><font style='color:blue'>" + msg.message +"</font>"; 
            	sessionStorage.setItem("messageHtml",messageHtml);
        	}
        }
    };
};

function getQueryString(name) { 
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); 
    var r = window.location.search.substr(1).match(reg); 
    if (r != null) return unescape(r[2]); 
    return null; 
} 
</script>

</html>