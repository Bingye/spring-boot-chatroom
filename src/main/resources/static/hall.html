<!DOCTYPE html>
<html>
<head>
    <title>大厅</title>
   	<meta charset="UTF-8"/>
   	<script type="text/javascript" src="/spring-boot-chatroom/js/jquery-3.5.1.min.js"></script>
	<script type="text/javascript">
	//webSocket对象
	var ws;
	//时间间隔
	var tt;
	
	if ("WebSocket" in window) {
	    console.log("支持WebSocket")
	} else {
	    alert("该浏览器不支持WebSocket")
	}
	
	//获取昵称
	var username = getQueryString("username");;
	
	var wsUrl = 'ws://localhost/spring-boot-chatroom/websocket/hall';
	//创建链接
	try {
    	if(ws!=null){
    		alert("链接已经创建，请关闭页面或刷新页面");
    	}else{
    		//成功
            ws = new WebSocket(wsUrl);
            webSocketInit(wsUrl);//初始化webSocket连接函数
    	}
    } catch (e) {
        //失败
        console.log('catch');
    }
	
	//初始化方法，成功后执行
	function webSocketInit(wsUrl) {
	    //连接关闭函数
	    ws.onclose = function () {
	        console.log("连接已关闭...");
	    };
	    //连接错误函数
	    ws.onerror = function () {
	        console.log("连接错误...");
	    };
	    //连接建立,发送信息
	    ws.onopen = function (evt) {
	    	$("#messages").append("<br /><font style='color:red'>我已进入大厅");
	    };
	    //业务订阅成功后接受服务端推送消息  ，其实是个字符串
	    ws.onmessage = function (evt) {
	        
	    	var msg = JSON.parse(evt.data);
	        
		    //进入大厅
	        if(msg.msgType=="ENTHALL"){
	        	$("#roomUsernames").append("<li class='"+msg.fromuser+"'><input type='checkbox' value='"+msg.fromuser+"'>"+msg.fromuser+"</li>")	        			
	        
			//离开大厅
	        }else if(msg.msgType=="LEVHALL"){
	        	
	        	$("#roomUsernames").children().find("input[value='"+msg.fromuser+"']").parent().remove();
	        
	        //被邀请聊天
	        }else if(msg.msgType=="ENTROOM"){
        		window.open("/spring-boot-chatroom/room.html?roomId="+msg.roomId,"_blank");        			
	        }
		    
	    };
	};
	
	//发起聊天
	function sendMsg() {
		//初始化房间用户对象
		var roomUsernames = [];
		
		//组装已选择用户
		$("#roomUsernames").children().each(function(){
			roomUsernames.push($(this).children("input[type='checkbox']:checked").val());
		});
		
		//发起聊天
	    $.ajax({
	    	url:"/spring-boot-chatroom/room/get/randomId",
	    	type:"get",
	    	data:{},
	    	success:function(res){
	    		var message = {
    		      	"msgType":"ENTROOM",
    		        "message": "发起聊天",
    		        "roomUsernames":roomUsernames,
    		        "roomId":res
    		    };
	    		
	    		//向ws发送信息
	    	    ws.send(JSON.stringify(message));
	    		window.open("/spring-boot-chatroom/room.html?roomId="+res,"_blank");
	    	}
	    });
	}
	
	function getQueryString(name) { 
	    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); 
	    var r = window.location.search.substr(1).match(reg); 
	    if (r != null) return unescape(r[2]); 
	    return null; 
	} 
	</script>
</head>
<body>
	<div style="text-align: left">
		<h1>大厅</h1>
		<div id="messages" style="text-align: left"></div><br/>
		大厅席位：
		<ul id="roomUsernames" style="width:200px;min-height:100px;border:1px solid gray;list-style-type: none;color:green;font-weight:bolder;"></ul>
		<input type="submit" id="submit" value="发起聊天" onclick="sendMsg()" />
	</div>
</body>
</html>